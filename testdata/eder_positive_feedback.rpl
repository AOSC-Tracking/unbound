; Test DNS Error Reporting for the positive flag

server:
	module-config: "validator iterator"
	trust-anchor-signaling: no
	target-fetch-policy: "0 0 0 0 0"
	verbosity: 4
	access-control: 127.0.0.1 allow_snoop
	qname-minimisation: no
	minimal-responses: no
	rrset-roundrobin: no
	ede: yes
	eder: yes

stub-zone:
	name: domain
	stub-addr: 0.0.0.1
stub-zone:
	name: an.agent
	stub-addr: 0.0.0.2
CONFIG_END

SCENARIO_BEGIN Test DNS Error Reporting for the positive flag

; domain
RANGE_BEGIN 0 100
	ADDRESS 0.0.0.1
	ENTRY_BEGIN
		MATCH opcode qtype qname
		ADJUST copy_id
		REPLY QR NOERROR
		SECTION QUESTION
			a.domain. IN DNSKEY
	ENTRY_END
	ENTRY_BEGIN
		MATCH opcode qtype qname
		ADJUST copy_id
		REPLY QR NOERROR
		SECTION QUESTION
			a.domain. IN A
		SECTION ANSWER
			a.domain. 5 IN A   0.0.0.0
		SECTION ADDITIONAL
			HEX_EDNSDATA_BEGIN
				ED ED				; opt-code
				00 0B				; opt-len
				80				; positive-flag
				02 61 6E 05 61 67 65 6E 74 00	; an.agent.
			HEX_EDNSDATA_END
	ENTRY_END
	ENTRY_BEGIN
		MATCH opcode qtype qname
		ADJUST copy_id
		REPLY QR NOERROR
		SECTION QUESTION
			b.domain. IN A
		SECTION ANSWER
			b.domain. 5 IN A   0.0.0.0
		SECTION ADDITIONAL
			HEX_EDNSDATA_BEGIN
				ED ED				; opt-code
				00 0B				; opt-len
				80				; positive-flag
				02 61 6E 05 61 67 65 6E 74 00	; an.agent.
			HEX_EDNSDATA_END
	ENTRY_END
RANGE_END

; an.agent
RANGE_BEGIN 0 9
	ADDRESS 0.0.0.2
	ENTRY_BEGIN
		MATCH opcode qtype qname
		ADJUST copy_id
		REPLY QR NOERROR
		SECTION QUESTION
			_er.49152.10.an.agent._er.an.agent. IN NULL
		SECTION AUTHORITY
			an.agent. IN SOA ns email 1 2 3 4 10
	ENTRY_END
RANGE_END

; Query
STEP 0 QUERY
ENTRY_BEGIN
REPLY RD
SECTION QUESTION
a.domain. IN A
ENTRY_END

; Check that resolution worked
STEP 1 CHECK_ANSWER
ENTRY_BEGIN
MATCH all
REPLY QR RD RA NOERROR
SECTION QUESTION
a.domain. IN A
SECTION ANSWER
a.domain. IN A 0.0.0.0
ENTRY_END

STEP 2 TRAFFIC

; Check explicitly that the EDER query is cached (no RD bit).
STEP 10 QUERY
ENTRY_BEGIN
REPLY
SECTION QUESTION
_er.49152.10.an.agent._er.an.agent. IN NULL
ENTRY_END

; At this range there are no configured agents to answer this.
; If the EDER query is not answered from the cache the test will fail with
; pending messages.
STEP 11 CHECK_ANSWER
ENTRY_BEGIN
MATCH all
REPLY QR RA NOERROR
SECTION QUESTION
_er.49152.10.an.agent._er.an.agent. IN NULL
SECTION AUTHORITY
an.agent. IN SOA ns email 1 2 3 4 10
ENTRY_END

; Query
STEP 20 QUERY
ENTRY_BEGIN
REPLY RD
SECTION QUESTION
b.domain. IN A
ENTRY_END

; Check that resolution worked
STEP 21 CHECK_ANSWER
ENTRY_BEGIN
MATCH all
REPLY QR RD RA NOERROR
SECTION QUESTION
b.domain. IN A
SECTION ANSWER
b.domain. IN A 0.0.0.0
ENTRY_END

; By this time an EDER query should have been generated like above but because
; that query is deterministic and already cached, no outgoing packets will
; occur. Otherwise the test would have failed with pending messages.

SCENARIO_END
