# #-- edns_upstream_cookies.pre --#
# source the master var file when it's there
[ -f ../.tpkg.var.master ] && source ../.tpkg.var.master
# use .tpkg.var.test for in test variable passing
[ -f .tpkg.var.test ] && source .tpkg.var.test

. ../common.sh
get_random_port 2
UNBOUND_PORT=$RND_PORT
UNBOUND2_PORT=$(($RND_PORT + 1))
echo "UNBOUND_PORT=$UNBOUND_PORT" >> .tpkg.var.test
echo "NSD_PORT=$NSD_PORT" >> .tpkg.var.test

UPSTREAM_IP=10.0.0.1
UB_IP1=192.128.123.121
UB_IP2=192.128.123.122

echo "UPSTREAM_IP=$UPSTREAM_IP" >> .tpkg.var.test
echo "UB_IP1=$UB_IP1" >> .tpkg.var.test
echo "UB_IP2=$UB_IP2" >> .tpkg.var.test


# rewrite config file with created ports
sed -e 's/@PORT\@/'$UNBOUND_PORT'/' < unbound.conf > ub.conf
sed -e 's/@PORT2\@/'$UNBOUND2_PORT'/' < unbound_auth.conf > temp2.conf
sed -e 's/@IP2\@/'$UPSTREAM_IP'/' < temp2.conf > ub2.conf


# create virtual interfaces
ip link add veth0 type veth peer name veth1
ip link add veth0 type veth peer name veth1
ip link set dev veth0 up
ip link set dev veth1 up

ip addr add $UPSTREAM_IP dev veth0
ip addr add $UB_IP1 dev veth1

# start unbound in the background
PRE="../.."
$PRE/unbound -d -c ub.conf > unbound.log 2>&1 &
UNBOUND_PID=$!
echo "UNBOUND_PID=$UNBOUND_PID" >> .tpkg.var.test

# start nsd in the background (for downstream cookies)
$PRE/unbound -d -c ub2.conf > unbound2.log 2>&1 &
UNBOUND_PID2=$!
echo "UNBOUND_PID2=$UNBOUND_PID2" >> .tpkg.var.test

cat .tpkg.var.test
wait_unbound_up unbound.log
wait_unbound_up unbound2.log

