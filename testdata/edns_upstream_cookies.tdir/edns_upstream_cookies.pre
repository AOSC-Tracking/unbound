# #-- edns_upstream_cookies.pre --#
# source the master var file when it's there
[ -f ../.tpkg.var.master ] && source ../.tpkg.var.master
# use .tpkg.var.test for in test variable passing
[ -f .tpkg.var.test ] && source .tpkg.var.test

. ../common.sh
get_random_port 2
UNBOUND_PORT=$RND_PORT
NSD_PORT=$(($RND_PORT + 1))
echo "UNBOUND_PORT=$UNBOUND_PORT" >> .tpkg.var.test
echo "NSD_PORT=$NSD_PORT" >> .tpkg.var.test

# rewrite config file with created ports
sed -e 's/@PORT\@/'$UNBOUND_PORT'/' < edns_upstream_cookies.conf > temp.conf
# sed -e 's/@PORT2\@/'$NSD_PORT'/' < temp.conf > ub.conf
sed -e 's/@PORT2\@/'$NSD_PORT'/' < nsd.conf > nsd1.conf

# start unbound in the background
PRE="../.."
$PRE/unbound -d -c ub.conf > unbound.log 2>&1 &
UNBOUND_PID=$!
echo "UNBOUND_PID=$UNBOUND_PID" >> .tpkg.var.test

# start nsd in the background (for downstream cookies)
# TODO replace this with unbound when downstream cookies are available
nsd -d -c nsd1.conf > nsd1.log 2>&1 &
NSD_PID=$!
echo "NSD_PID=$NSD_PID" >> .tpkg.var.test

cat .tpkg.var.test
wait_unbound_up unbound.log
wait_unbound_up nsd1.log

