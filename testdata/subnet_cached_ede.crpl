; Ask the same question twice. Check to see second is answered
; from cache

server:
	trust-anchor-signaling: no
	target-fetch-policy: "0 0 0 0 0"
	send-client-subnet: 1.2.3.4
	max-client-subnet-ipv4: 17
	module-config: "subnetcache validator iterator"
	verbosity: 3
	qname-minimisation: no
	minimal-responses: no
	ede: yes
	val-log-level: 2
        trust-anchor: "example.nl. DS 50602 8 2 FA8EE175C47325F4BD46D8A4083C3EBEB11C977D689069F2B41F1A29B22446B1"

stub-zone:
	name: "example.nl"
	stub-addr:  1.2.3.4
CONFIG_END

SCENARIO_BEGIN Test subnetcache support for caching EDEs.

; ns.example.com.
RANGE_BEGIN 0 100
	ADDRESS 1.2.3.4
ENTRY_BEGIN
MATCH opcode qtype qname
ADJUST copy_id
REPLY QR AA NOERROR
SECTION QUESTION
example.nl.	IN	DNSKEY
SECTION ANSWER
SECTION ADDITIONAL
	HEX_EDNSDATA_BEGIN
					; client is 127.0.0.1
		00 08 		; OPC
		00 07 		; option length
		00 01 		; Family
		11 00 		; source mask, scopemask
		7f 00 00 	; address
	HEX_EDNSDATA_END
ENTRY_END

ENTRY_BEGIN
MATCH opcode qtype qname
ADJUST copy_id
REPLY QR AA NOERROR
SECTION QUESTION
example.nl.	IN	A
SECTION ANSWER
example.nl.	IN	A	1.2.3.4
SECTION ADDITIONAL
	HEX_EDNSDATA_BEGIN
					; client is 127.0.0.1
		00 08 		; OPC
		00 07 		; option length
		00 01 		; Family
		11 00 		; source mask, scopemask
		7f 00 00 	; address
	HEX_EDNSDATA_END
ENTRY_END
RANGE_END
			ns.example.com.		IN 	A	1.2.3.4
			www.example.com.        3600    IN      RRSIG   A 3 3 3600 20070926134150 20070829134150 2854 example.com. MC0CFC99iE9K5y2WNgI0gFvBWaTi9wm6AhUAoUqOpDtG5Zct+Qr9F3mSdnbc6V4= ;{id = 2854}
	ENTRY_END
RANGE_END

; get the entry in cache.
STEP 1 QUERY
ENTRY_BEGIN
REPLY RD DO
SECTION QUESTION
example.nl. IN A
SECTION ADDITIONAL
	HEX_EDNSDATA_BEGIN
		00 08 00 07					; OPC, optlen
		00 01 11 00					; ip4, scope 17, source 0
		7f 00 00   					;127.0.0.0/17
	HEX_EDNSDATA_END
ENTRY_END

; get the answer for it
STEP 10 CHECK_ANSWER
ENTRY_BEGIN
MATCH all ede=9
REPLY QR RD RA DO SERVFAIL
SECTION QUESTION
example.nl. IN A
ENTRY_END

; query again for the cached entry
STEP 20 QUERY
ENTRY_BEGIN
REPLY RD
SECTION QUESTION
example.nl. IN A
SECTION ADDITIONAL
	HEX_EDNSDATA_BEGIN
		00 08 00 07					; OPC, optlen
		00 01 11 00					; ip4, scope 17, source 0
		7f 00 00   					;127.0.0.0/17
	HEX_EDNSDATA_END
ENTRY_END

; this must be a cached answer since stub is not answering in this range
STEP 30 CHECK_ANSWER
ENTRY_BEGIN
MATCH all ede=9
REPLY QR RD RA DO SERVFAIL
SECTION QUESTION
example.nl. IN A
ENTRY_END

;STEP 10 CHECK_ANSWER
;ENTRY_BEGIN
;	MATCH all ednsdata
;	REPLY QR RD RA AD NOERROR
;	SECTION QUESTION
;		www.example.com. IN A
;	SECTION ANSWER
;		www.example.com. IN A	10.20.30.40
;		www.example.com.        3600    IN      RRSIG   A 3 3 3600 20070926134150 20070829134150 2854 example.com. MC0CFC99iE9K5y2WNgI0gFvBWaTi9wm6AhUAoUqOpDtG5Zct+Qr9F3mSdnbc6V4= ;{id = 2854}
;	SECTION AUTHORITY
;		example.com.	IN NS	ns.example.com.
;		example.com.    3600    IN      RRSIG   NS 3 2 3600 20070926134150 20070829134150 2854 example.com. MC0CFQCN+qHdJxoI/2tNKwsb08pra/G7aAIUAWA5sDdJTbrXA1/3OaesGBAO3sI= ;{id = 2854}
;	SECTION ADDITIONAL
;		HEX_EDNSDATA_BEGIN
;						; client is 127.0.0.1
;			00 08 		; OPC
;			00 07 		; option length
;			00 01 		; Family
;			11 11 		; source mask, scopemask
;			7f 00 00 	; address
;		HEX_EDNSDATA_END
;		ns.example.com.		IN 	A	1.2.3.4
;		ns.example.com. 3600    IN      RRSIG   A 3 3 3600 20070926134150 20070829134150 2854 example.com. MC0CFQCQMyTjn7WWwpwAR1LlVeLpRgZGuQIUCcJDEkwAuzytTDRlYK7nIMwH1CM= ;{id = 2854}
;ENTRY_END
;
;STEP 11 QUERY
;
;ENTRY_BEGIN
;	HEX_ANSWER_BEGIN;
;		00 00 00 00 00 01 00 00		;ID 0, no RD
;		00 00 00 01 03 77 77 77		; www.example.com A? (DO)
;		07 65 78 61 6d 70 6c 65 
;		03 63 6f 6d 00 00 01 00
;		01 00 00 29 10 00 00 00 
;		80 00 00 0b
;		
;		00 08 00 07					; OPC, optlen
;		00 01 12 00					; ip4, scope 18, source 0
;		7f 00 00   					;127.0.0.0/18
;	HEX_ANSWER_END
;ENTRY_END
;
;STEP 20 CHECK_ANSWER
;ENTRY_BEGIN
;	MATCH all ednsdata
;	REPLY QR RA AD NOERROR
;	SECTION QUESTION
;		www.example.com. IN A
;	SECTION ANSWER
;		www.example.com. IN A	10.20.30.40
;		www.example.com.        3600    IN      RRSIG   A 3 3 3600 20070926134150 20070829134150 2854 example.com. MC0CFC99iE9K5y2WNgI0gFvBWaTi9wm6AhUAoUqOpDtG5Zct+Qr9F3mSdnbc6V4= ;{id = 2854}
;	SECTION AUTHORITY
;		example.com.	IN NS	ns.example.com.
;		example.com.    3600    IN      RRSIG   NS 3 2 3600 20070926134150 20070829134150 2854 example.com. MC0CFQCN+qHdJxoI/2tNKwsb08pra/G7aAIUAWA5sDdJTbrXA1/3OaesGBAO3sI= ;{id = 2854}
;	SECTION ADDITIONAL
;		HEX_EDNSDATA_BEGIN
;						; client is 127.0.0.1
;			00 08 		; OPC
;			00 07 		; option length
;			00 01 		; Family
;			12 11 		; source mask, scopemask
;			7f 00 00 	; address
;		HEX_EDNSDATA_END
;		ns.example.com.		IN 	A	1.2.3.4
;		ns.example.com. 3600    IN      RRSIG   A 3 3 3600 20070926134150 20070829134150 2854 example.com. MC0CFQCQMyTjn7WWwpwAR1LlVeLpRgZGuQIUCcJDEkwAuzytTDRlYK7nIMwH1CM= ;{id = 2854}
;ENTRY_END

SCENARIO_END
